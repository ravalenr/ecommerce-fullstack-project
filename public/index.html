<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Multi Store Eletro - the best Electronics and Appliances products with quality and fair prices in S√£o Paulo.">
    <title>Multi Store Eletro - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Enhanced Header with Search -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-logo">
                <a href="index.html">
                    <img src="img/logotipo.png" alt="Multi Store Eletro Logo" />
                </a>
            </div>

            <div class="header-search">
                <form class="search-form" onsubmit="handleSearch(event)">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search for products..." autocomplete="off">
                    <button type="submit" class="search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </form>
                <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
            </div>

            <div class="header-actions">
                <div class="account-menu">
                    <button class="account-btn" id="accountBtn" onclick="toggleAccountMenu()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <div class="account-info">
                            <span class="account-greeting">Hello</span>
                            <span class="account-name" id="accountName">Sign In</span>
                        </div>
                    </button>

                    <div class="account-dropdown" id="accountDropdown">
                        <!-- navigation links now inside dropdown -->
                        <div class="dropdown-nav-links">
                            <a href="index.html" class="dropdown-item">Home</a>
                            <a href="products.html" class="dropdown-item">Products</a>
                            <a href="about.html" class="dropdown-item">About</a>
                            <a href="contact.html" class="dropdown-item">Contact</a>
                        </div>
                        <div class="dropdown-divider"></div>

                        <div id="loggedOutMenu">
                            <a href="login.html" class="dropdown-btn primary">Sign In</a>
                            <p class="dropdown-text">New customer? <a href="register.html">Start here</a></p>
                        </div>
                        <div id="loggedInMenu" style="display: none;">
                            <div class="dropdown-user">
                                <strong id="userName">User Name</strong>
                                <span id="userEmail">user@example.com</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="profile.html" class="dropdown-item">My Account</a>
                            <a href="#" class="dropdown-item" id="logoutBtn" onclick="handleLogout(event)">Sign Out</a>
                        </div>
                    </div>
                </div>

                <a href="cart.html" class="cart-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadge">0</span>
                    <div class="cart-info">
                        <span class="cart-greeting">Cart</span>
                        <span class="cart-count" id="cartCount">0 items</span>
                    </div>
                </a>
            </div>

            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Hero Carousel Section -->
    <section class="hero-carousel">
        <div class="carousel-container">
            <!-- Carousel Slides -->
            <div class="carousel-slides">
                <!-- Slide 1 - Hero -->
                <div class="carousel-slide active">
                    <a href="products.html" class="slide-link">
                        <img src="img/hero-index1.png" alt="Hero">
                        <div class="slide-caption">
                        </div>
                    </a>
                </div>
                <!-- Slide 2 - Computers -->
                <div class="carousel-slide active">
                    <a href="products.html?search=computer" class="slide-link">
                        <img src="img/computers.jpeg" alt="Computers & Laptops">
                        <div class="slide-caption">
                            <h2>Computers & Laptops</h2>
                            <p>Discover our latest collection</p>
                        </div>
                    </a>
                </div>

                <!-- Slide 3 - TVs -->
                <div class="carousel-slide">
                    <a href="products.html?search=tv" class="slide-link">
                        <img src="img/tvs.jpeg" alt="Smart TVs">
                        <div class="slide-caption">
                            <h2>Smart TVs</h2>
                            <p>Experience entertainment like never before</p>
                        </div>
                    </a>
                </div>

                <!-- Slide 4 - Photography -->
                <div class="carousel-slide">
                    <a href="products.html?search=camera" class="slide-link">
                        <img src="img/photography.jpeg" alt="Cameras & Photography">
                        <div class="slide-caption">
                            <h2>Cameras & Photography</h2>
                            <p>Capture every moment perfectly</p>
                        </div>
                    </a>
                </div>

                <!-- Slide 5 - Appliances -->
                <div class="carousel-slide">
                    <a href="products.html?search=appliance" class="slide-link">
                        <img src="img/fridge.jpeg" alt="Home Appliances">
                        <div class="slide-caption">
                            <h2>Home Appliances</h2>
                            <p>Make your life easier</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Navigation Arrows -->
            <button class="carousel-btn prev" onclick="changeSlide(-1)" aria-label="Previous slide">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="carousel-btn next" onclick="changeSlide(1)" aria-label="Next slide">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>

            <!-- Dots Navigation -->
            <div class="carousel-dots">
                <span class="dot active" onclick="goToSlide(0)"></span>
                <span class="dot" onclick="goToSlide(1)"></span>
                <span class="dot" onclick="goToSlide(2)"></span>
                <span class="dot" onclick="goToSlide(3)"></span>
                <span class="dot" onclick="goToSlide(4)"></span>
            </div>
        </div>
    </section>

    <!-- Hot Deals Section -->
    <section class="section hot-deals-section" id="hotDealsSection" style="display: none;">
        <div class="section-header">
            <h2>Hot Deals - Limited Time!</h2>
            <a href="products.html?deals=true" class="view-all-link">View all deals</a>
        </div>
        <div id="hotDealsLoading" class="loading-container">
            <div class="spinner"></div>
            <p>Loading hot deals...</p>
        </div>
        <div class="products-grid" id="hotDealsGrid"></div>
    </section>

    <!-- Latest Products Section -->
    <section class="section latest-products-section">
        <div class="section-header">
            <h2>Latest Products</h2>
            <a href="products.html" class="view-all-link">View all products</a>
        </div>
        <div id="latestLoading" class="loading-container">
            <div class="spinner"></div>
            <p>Loading latest products...</p>
        </div>
        <div class="products-grid" id="latestProductsGrid"></div>
    </section>

    <!-- Categories Section -->
    <section class="section categories-section">
        <h2>Shop by Category</h2>
        <div class="categories-grid">
            <a href="products.html?category=1" class="category-card">
                <div class="category-icon">üì∫</div>
                <h3>Smart TVs</h3>
                <p>4K & OLED displays</p>
            </a>
            <a href="products.html?category=2" class="category-card">
                <div class="category-icon">‚ùÑÔ∏è</div>
                <h3>Refrigerators</h3>
                <p>Energy efficient</p>
            </a>
            <a href="products.html?category=3" class="category-card">
                <div class="category-icon">üíª</div>
                <h3>Computers</h3>
                <p>Laptops & Desktops</p>
            </a>
            <a href="products.html?category=4" class="category-card">
                <div class="category-icon">üì±</div>
                <h3>Smartphones</h3>
                <p>Latest models</p>
            </a>
            <a href="products.html?category=5" class="category-card">
                <div class="category-icon">üçΩÔ∏è</div>
                <h3>Microwaves</h3>
                <p>Quick cooking</p>
            </a>
            <a href="products.html?category=6" class="category-card">
                <div class="category-icon">üì∑</div>
                <h3>Cameras</h3>
                <p>DSLR & Mirrorless</p>
            </a>
        </div>
    </section>

    <!-- Why Choose Us Section -->
    <section class="section features-section">
        <h2>Why Choose Multi Store Eletro?</h2>
        <div class="features-grid">
            <div class="feature-card">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#003366" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <h3>Quality Products</h3>
                <p>Only the best from trusted brands</p>
            </div>
            <div class="feature-card">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ff6600" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <h3>Best Prices</h3>
                <p>Competitive pricing guaranteed</p>
            </div>
            <div class="feature-card">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <h3>Expert Support</h3>
                <p>Knowledgeable team ready to help</p>
            </div>
            <div class="feature-card">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#003366" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
                <h3>Fast Delivery</h3>
                <p>Quick and reliable shipping</p>
            </div>
        </div>
    </section>

    <!-- WhatsApp Float Button -->
    <a href="https://api.whatsapp.com/send?phone=5511991215175&text=Ol√°%2C%20gostaria%20de%20saber%20mais%20sobre%20os%20produtos!" 
        class="whatsapp-float" 
        target="_blank" 
        title="Contact us on WhatsApp">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp" width="50">
    </a>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Multi Store Eletro - All rights reserved.</p>
    </footer>

    <!-- Load utility functions first (includes shared helpers) -->
    <script src="js/utils.js"></script>
    <!-- Load header functionality (handles auth, cart, search) -->
    <script src="header-script.js"></script>
    <script>
        // ========================================
        // CAROUSEL FUNCTIONALITY
        // ========================================

        let currentSlide = 0;
        let autoSlideInterval;

        /**
         * Change to next or previous slide
         * @param {number} direction - 1 for next, -1 for previous
         */
        function changeSlide(direction) {
            const slides = document.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll('.dot');

            // Remove active class from current slide and dot
            slides[currentSlide].classList.remove('active');
            dots[currentSlide].classList.remove('active');

            // Calculate new slide index
            currentSlide = currentSlide + direction;

            // Loop back to start or end if necessary
            if (currentSlide >= slides.length) {
                currentSlide = 0;
            } else if (currentSlide < 0) {
                currentSlide = slides.length - 1;
            }

            // Add active class to new slide and dot
            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');

            // Reset auto-slide timer
            resetAutoSlide();
        }

        /**
         * Go to a specific slide
         * @param {number} slideIndex - The index of the slide to show
         */
        function goToSlide(slideIndex) {
            const slides = document.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll('.dot');

            // Remove active class from current slide and dot
            slides[currentSlide].classList.remove('active');
            dots[currentSlide].classList.remove('active');

            // Set new current slide
            currentSlide = slideIndex;

            // Add active class to new slide and dot
            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');

            // Reset auto-slide timer
            resetAutoSlide();
        }

        /**
         * Start automatic slide rotation
         */
        function startAutoSlide() {
            // Change slide every 5 seconds
            autoSlideInterval = setInterval(() => {
                changeSlide(1);
            }, 5000);
        }

        /**
         * Stop and restart the auto-slide timer
         * Called when user manually changes slides
         */
        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        }

        // Start auto-sliding when page loads
        document.addEventListener('DOMContentLoaded', () => {
            startAutoSlide();
        });

        // Pause auto-slide when user hovers over carousel
        const carousel = document.querySelector('.hero-carousel');
        if (carousel) {
            carousel.addEventListener('mouseenter', () => {
                clearInterval(autoSlideInterval);
            });

            carousel.addEventListener('mouseleave', () => {
                startAutoSlide();
            });
        }

        // ========================================
        // PAGE INITIALIZATION
        // ========================================

        // We can use the global API_URL from utils.js now

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            await checkAuthAndPersonalize();
            await loadHotDeals();
            await loadLatestProducts();
        }

        /**
         * Check authentication and personalize welcome
         */
        async function checkAuthAndPersonalize() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const userData = data.data || data;
                    const firstName = userData.full_name ? userData.full_name.split(' ')[0] : 'User';
                    document.getElementById('welcomeTitle').textContent = `Welcome back, ${firstName}!`;
                    document.getElementById('welcomeSubtitle').textContent = 'Ready to find your next favorite product?';
                }
            } catch (error) {
                console.log('Guest user');
            }
        }

        /**
         * Load hot deals
         */
        async function loadHotDeals() {
            try {
                const response = await fetch(`${API_URL}/products`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const productsArray = extractProductsArray(data);
                    
                    const hotDeals = productsArray.filter(p => parseFloat(p.discount_percentage || 0) > 0).slice(0, 4);
                    
                    if (hotDeals.length > 0) {
                        displayHotDeals(hotDeals);
                    } else {
                        document.getElementById('hotDealsSection').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading hot deals:', error);
                document.getElementById('hotDealsSection').style.display = 'none';
            }
        }

        /**
         * Display hot deals
         */
        function displayHotDeals(products) {
            const section = document.getElementById('hotDealsSection');
            const loading = document.getElementById('hotDealsLoading');
            const grid = document.getElementById('hotDealsGrid');

            loading.style.display = 'none';
            section.style.display = 'block';
            grid.style.display = 'grid';  // make sure grid shows up
            grid.innerHTML = products.map(product => createProductCard(product)).join('');
        }

        /**
         * Load latest products
         */
        async function loadLatestProducts() {
            try {
                console.log('Fetching products from API...');
                const response = await fetch(`${API_URL}/products?limit=8`, {
                    credentials: 'include'
                });

                console.log('Got response, status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('API returned data:', data);

                    const productsArray = extractProductsArray(data);
                    console.log('Extracted products count:', productsArray.length);

                    // check if we actually got products back
                    if (productsArray.length === 0) {
                        console.warn('No products found in response!');
                    }

                    displayLatestProducts(productsArray);
                } else {
                    console.error('API error, status code:', response.status);
                    showError('latestLoading', 'Error loading products');
                }
            } catch (error) {
                console.error('Failed to load products:', error);
                showError('latestLoading', 'Error connecting to server');
            }
        }

        /**
         * Display latest products
         */
        function displayLatestProducts(products) {
            console.log('displayLatestProducts called with', products.length, 'products');

            const loading = document.getElementById('latestLoading');
            const grid = document.getElementById('latestProductsGrid');

            console.log('Loading element:', loading);
            console.log('Grid element:', grid);

            if (!grid) {
                console.error('Products grid element not found!');
                return;
            }

            // hide the loading spinner
            loading.style.display = 'none';
            console.log('Loading hidden');

            // generate HTML for first product to test
            if (products.length > 0) {
                console.log('First product:', products[0]);
                const firstCardHTML = createProductCard(products[0]);
                console.log('First card HTML:', firstCardHTML);
            }

            // make sure grid is visible and add products
            grid.style.display = 'grid';
            const allHTML = products.map(product => createProductCard(product)).join('');
            console.log('Generated HTML length:', allHTML.length);
            console.log('First 200 chars of HTML:', allHTML.substring(0, 200));

            grid.innerHTML = allHTML;

            console.log('Grid innerHTML length after setting:', grid.innerHTML.length);
            console.log('Grid display style:', grid.style.display);
            console.log('Grid computed display:', window.getComputedStyle(grid).display);
        }

        /**
         * Create product card HTML
         */
        function createProductCard(product) {
            const price = parseFloat(product.price) || 0;
            const discount = parseFloat(product.discount_percentage) || 0;
            const discountedPrice = price - (price * discount / 100);

            return `
                <div class="product-card is-visible">
                    <div class="product-image">
                        <img src="${product.image_url || 'img/default-product.png'}" 
                             alt="${product.product_name}"
                             onerror="this.src='img/default-product.png'">
                        ${discount > 0 ? `
                            <span class="product-badge hot-deal">${discount}% OFF</span>
                        ` : product.is_featured ? `
                            <span class="product-badge featured">Featured</span>
                        ` : ''}
                    </div>
                    <div class="product-details">
                        <h3 class="product-name">${product.product_name}</h3>
                        <p class="product-description">${truncateText(product.description || '', 60)}</p>
                        <div class="product-price">
                            ${discount > 0 ? `
                                <span class="price-original">$${price.toFixed(2)}</span>
                                <span class="price-current">$${discountedPrice.toFixed(2)}</span>
                            ` : `
                                <span class="price-current">$${price.toFixed(2)}</span>
                            `}
                        </div>
                        <div class="product-stock">
                            ${product.stock_quantity > 0 
                                ? `<span class="in-stock">In Stock (${product.stock_quantity})</span>`
                                : '<span class="out-of-stock">Out of Stock</span>'}
                        </div>
                        <button class="add-to-cart-btn" 
                                onclick="addToCart(${product.product_id})"
                                ${product.stock_quantity === 0 ? 'disabled' : ''}>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            ${product.stock_quantity === 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            `;
        }

        // addToCart, showNotification, and truncateText are now in utils.js

        /**
         * Show error message
         */
        function showError(loadingId, message) {
            const loading = document.getElementById(loadingId);
            if (loading) {
                loading.innerHTML = `
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <p>${message}</p>
                `;
            }
        }

        // handleSearch, toggleAccountMenu, toggleMobileMenu, and handleLogout are now in utils.js
    </script>

</body>
</html>