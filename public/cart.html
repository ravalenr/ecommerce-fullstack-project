<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Multi Store Eletro</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <div class="header-logo">
                <a href="index.html">
                    <img src="img/logotipo.png" alt="Multi Store Eletro Logo" />
                </a>
            </div>

            <div class="header-search">
                <form class="search-form" onsubmit="handleSearch(event)">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search for products..." autocomplete="off">
                    <button type="submit" class="search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </form>
                <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
            </div>

            <div class="header-actions">
                <div class="account-menu">
                    <button class="account-btn" id="accountBtn" onclick="toggleAccountMenu()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <div class="account-info">
                            <span class="account-greeting">Hello</span>
                            <span class="account-name" id="accountName">Sign In</span>
                        </div>
                    </button>

                    <div class="account-dropdown" id="accountDropdown">
                        <div class="dropdown-nav-links">
                            <a href="index.html" class="dropdown-item">Home</a>
                            <a href="products.html" class="dropdown-item">Products</a>
                            <a href="about.html" class="dropdown-item">About</a>
                            <a href="contact.html" class="dropdown-item">Contact</a>
                        </div>
                        <div class="dropdown-divider"></div>

                        <div id="loggedOutMenu">
                            <a href="login.html" class="dropdown-btn primary">Sign In</a>
                            <p class="dropdown-text">New customer? <a href="register.html">Start here</a></p>
                        </div>
                        <div id="loggedInMenu" style="display: none;">
                            <div class="dropdown-user">
                                <strong id="userName">User Name</strong>
                                <span id="userEmail">user@example.com</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="profile.html" class="dropdown-item">My Account</a>
                            <a href="#" class="dropdown-item" id="logoutBtn" onclick="handleLogout(event)">Sign Out</a>
                        </div>
                    </div>
                </div>

                <a href="cart.html" class="cart-btn cart-btn-active">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadge">0</span>
                    <div class="cart-info">
                        <span class="cart-greeting">Cart</span>
                        <span class="cart-count" id="cartCount">0 items</span>
                    </div>
                </a>
            </div>

            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </header>

    <section class="cart-section">
        <div class="cart-container">
            <h1 class="cart-title">Shopping Cart</h1>

            <div id="loadingState" class="loading-state">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#003366" stroke-width="2">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                <p>Loading your cart...</p>
            </div>

            <div id="emptyCart" class="empty-cart" style="display: none;">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <h2>Your cart is empty</h2>
                <p>Add some products to get started!</p>
                <a href="products.html" class="shop-now-btn">Shop Now</a>
            </div>

            <div id="cartContent" style="display: none;">
                <div class="cart-layout">
                    <div class="cart-items-section">
                        <div class="cart-items" id="cartItems"></div>
                        
                        <div class="cart-actions">
                            <button class="clear-cart-btn" id="clearCartBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Clear Cart
                            </button>
                            <a href="products.html" class="continue-shopping-btn">Continue Shopping</a>
                        </div>
                    </div>

                    <div id="checkoutModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                        <div class="modal-content" style="background:white; margin:10% auto; padding:20px; max-width:500px; border-radius:8px;">
                            <h2>Checkout</h2>
                            <form id="checkoutForm">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="orderName" required class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="orderEmail" required class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <textarea id="orderAddress" required class="form-control"></textarea>
                                </div>
                                <div class="form-actions" style="margin-top:20px;">
                                    <button type="submit" class="btn-primary">Place Order</button>
                                    <button type="button" onclick="document.getElementById('checkoutModal').style.display='none'">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="cart-summary-section">
                        <div class="cart-summary">
                            <h2>Order Summary</h2>
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="summarySubtotal">$0.00</span>
                            </div>
                            <div class="summary-row discount-row" id="discountRow" style="display: none;">
                                <span>Discount:</span>
                                <span class="discount-amount" id="summaryDiscount">-$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping:</span>
                                <span class="shipping-free">FREE</span>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span class="total-amount" id="summaryTotal">$0.00</span>
                            </div>
                            <button class="checkout-btn" id="checkoutBtn">
                                Proceed to Checkout
                            </button>
                            <div class="security-badge">
                                <span>Secure Checkout</span>
                            </div>
                            <div class="guest-notice" id="guestNotice" style="display: none;">
                                <p>Not logged in? <a href="login.html?redirect=cart.html">Login</a> to save your cart!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>About Us</h3>
                    <p>Multi Store Eletro is your trusted destination for quality electronics and appliances. We offer the best products at competitive prices.</p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="products.html">Products</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <ul>
                        <li>Email: info@multistore.com</li>
                        <li>Phone: (555) 123-4567</li>
                        <li>Address: 123 Tech Street, Dublin</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Multi Store Eletro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/utils.js"></script>
    <script src="header-script.js"></script>

    <script>
        // Use the global API_URL from utils.js
        let cartData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            setupEventListeners();
            // checkAuthStatus is now handled by header-script.js logic automatically
            // But we keep custom logic for the specific Guest Notice inside the cart body
            checkLocalAuth();
        });

        async function loadCart() {
            try {
                const response = await fetch(`${API_URL}/cart`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    cartData = await response.json();
                    displayCart(cartData.data);
                } else {
                    showError('Error loading cart');
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                showError('Error connecting to server');
            }
        }

        function displayCart(data) {
            const loadingState = document.getElementById('loadingState');
            const emptyCart = document.getElementById('emptyCart');
            const cartContent = document.getElementById('cartContent');

            loadingState.style.display = 'none';

            if (data.items.length === 0) {
                emptyCart.style.display = 'flex';
                cartContent.style.display = 'none';
                // updateCartCount is handled by header-script.js, but we can sync here
                if(window.updateCartCount) window.updateCartCount();
            } else {
                emptyCart.style.display = 'none';
                cartContent.style.display = 'block';
                renderCartItems(data.items);
                renderSummary(data.summary);
                if(window.updateCartCount) window.updateCartCount();
            }
        }

        function renderCartItems(items) {
            const cartItemsContainer = document.getElementById('cartItems');
            cartItemsContainer.innerHTML = '';
            items.forEach(item => {
                cartItemsContainer.appendChild(createCartItemElement(item));
            });
        }


        function createCartItemElement(item) {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.setAttribute('data-cart-id', item.cart_id);

            // Price Calculations
            const price = Number(item.price);
            const discountedSubtotal = Number(item.discounted_subtotal);

            // Discounted Price Calculation
            const discountPrice = item.discount_percentage > 0 
                ? price - (price * item.discount_percentage / 100)
                : price;

            // Image Source Logic
            const imgSrc = item.image_url ? item.image_url : 'img/default-product.png';

            div.innerHTML = `
                <div class="item-image">
                    <img src="${imgSrc}" alt="${item.product_name}" onerror="this.src='img/default-product.png'">
                    ${item.discount_percentage > 0 ? `<span class="item-discount-badge">${item.discount_percentage}% OFF</span>` : ''}
                </div>
                <div class="item-details">
                    <h3 class="item-name">${item.product_name}</h3> <p class="item-stock">
                        ${item.stock_quantity > 0 
                            ? `<span class="in-stock">In Stock (${item.stock_quantity} available)</span>`
                            : '<span class="out-of-stock">Out of Stock</span>'}
                    </p>
                    <div class="item-price">
                        ${item.discount_percentage > 0 
                            ? `<span class="price-original">$${price.toFixed(2)}</span>` 
                            : ''}
                        <span class="price-current">$${discountPrice.toFixed(2)}</span>
                    </div>
                </div>
                <div class="item-quantity">
                    <label>Quantity:</label>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <input type="number" value="${item.quantity}" min="1" max="${item.stock_quantity}" onchange="updateQuantity(${item.cart_id}, this.value)">
                        <button class="qty-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity + 1})" ${item.quantity >= item.stock_quantity ? 'disabled' : ''}>+</button>
                    </div>
                </div>
                <div class="item-total">
                    <span class="total-label">Total:</span>
                    <span class="total-price">$${discountedSubtotal.toFixed(2)}</span>
                </div>
                <button class="item-remove" onclick="removeItem(${item.cart_id})" title="Remove item">Remove</button>
            `;
            return div;
        }

        function renderSummary(summary) {
            document.getElementById('summarySubtotal').textContent = `$${summary.subtotal.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `$${summary.total_amount.toFixed(2)}`;
            const discountRow = document.getElementById('discountRow');
            if (summary.discount_amount > 0) {
                document.getElementById('summaryDiscount').textContent = `-$${summary.discount_amount.toFixed(2)}`;
                discountRow.style.display = 'flex';
            } else {
                discountRow.style.display = 'none';
            }
        }

        async function updateQuantity(cartId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            if (newQuantity < 1) return;
            try {
                const response = await fetch(`${API_URL}/cart/update/${cartId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ quantity: newQuantity })
                });
                if (response.ok) await loadCart();
            } catch (error) { console.error(error); }
        }

        async function removeItem(cartId) {
            if (!confirm('Remove this item?')) return;
            try {
                const response = await fetch(`${API_URL}/cart/remove/${cartId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) await loadCart();
            } catch (error) { console.error(error); }
        }

        async function clearCart() {
            if (!confirm('Clear entire cart?')) return;
            try {
                const response = await fetch(`${API_URL}/cart/clear`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) await loadCart();
            } catch (error) { console.error(error); }
        }

        function proceedToCheckout() {
            // Show the modal instead of redirecting
            document.getElementById('checkoutModal').style.display = 'block';

        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                full_name: document.getElementById('orderName').value,
                customer_email: document.getElementById('orderEmail').value,
                shipping_address: document.getElementById('orderAddress').value
            };

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Order placed successfully! Order ID: ' + result.data.orderId);
                    window.location.href = 'index.html'; // TO-DO: Redirect to order confirmation page if exists
                } else {
                    alert(result.message || 'Failed to place order');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('An error occurred');
            }
        });

        async function checkLocalAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, { credentials: 'include' });
                const guestNotice = document.getElementById('guestNotice');
                if (response.ok) {
                    if(guestNotice) guestNotice.style.display = 'none';
                } else {
                    if(guestNotice) guestNotice.style.display = 'block';
                }
            } catch (error) { console.log('Guest mode'); }
        }

        function setupEventListeners() {
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('checkoutBtn').addEventListener('click', proceedToCheckout);
        }

        function showError(message) {
            document.getElementById('loadingState').innerHTML = `<p style="color:red">${message}</p>`;
        }
    </script>
</body>
</html>