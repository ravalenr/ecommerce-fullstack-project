<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Multi Store Eletro</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <div class="logo">
                <a href="index.html">
                    <img src="img/logotipo.png" alt="Multi Store Eletro Logo" />
                </a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div class="account-menu">
                    <button class="account-btn" id="accountBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="accountText">Account</span>
                    </button>
                    <div class="account-dropdown" id="accountDropdown">
                        <div id="loggedOutMenu">
                            <a href="login.html" class="dropdown-item">Login</a>
                            <a href="register.html" class="dropdown-item">Register</a>
                        </div>
                        <div id="loggedInMenu" style="display: none;">
                            <a href="profile.html" class="dropdown-item">My Profile</a>
                            <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                </div>
                <a href="cart.html" class="cart-btn cart-btn-active">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadge">0</span>
                    <span class="cart-text">Cart</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Cart Section -->
    <section class="cart-section">
        <div class="cart-container">
            <h1 class="cart-title">Shopping Cart</h1>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#003366" stroke-width="2">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                <p>Loading your cart...</p>
            </div>

            <!-- Empty Cart State -->
            <div id="emptyCart" class="empty-cart" style="display: none;">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <h2>Your cart is empty</h2>
                <p>Add some products to get started!</p>
                <a href="products.html" class="shop-now-btn">Shop Now</a>
            </div>

            <!-- Cart Content -->
            <div id="cartContent" style="display: none;">
                <div class="cart-layout">
                    <!-- Cart Items -->
                    <div class="cart-items-section">
                        <div class="cart-items" id="cartItems">
                            <!-- Cart items will be inserted here by JavaScript -->
                        </div>
                        
                        <!-- Cart Actions -->
                        <div class="cart-actions">
                            <button class="clear-cart-btn" id="clearCartBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Clear Cart
                            </button>
                            <a href="products.html" class="continue-shopping-btn">Continue Shopping</a>
                        </div>
                    </div>

                    <!-- Cart Summary -->
                    <div class="cart-summary-section">
                        <div class="cart-summary">
                            <h2>Order Summary</h2>
                            
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="summarySubtotal">$0.00</span>
                            </div>
                            
                            <div class="summary-row discount-row" id="discountRow" style="display: none;">
                                <span>Discount:</span>
                                <span class="discount-amount" id="summaryDiscount">-$0.00</span>
                            </div>
                            
                            <div class="summary-row">
                                <span>Shipping:</span>
                                <span class="shipping-free">FREE</span>
                            </div>
                            
                            <div class="summary-divider"></div>
                            
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span class="total-amount" id="summaryTotal">$0.00</span>
                            </div>

                            <!-- Checkout Button -->
                            <button class="checkout-btn" id="checkoutBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                Proceed to Checkout
                            </button>

                            <!-- Security Badge -->
                            <div class="security-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                <span>Secure Checkout</span>
                            </div>

                            <!-- Guest Notice -->
                            <div class="guest-notice" id="guestNotice" style="display: none;">
                                <p>Not logged in? <a href="login.html?redirect=cart.html">Login</a> or <a href="register.html">Register</a> to save your cart!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Multi Store Eletro. All rights reserved.</p>
    </footer>

    <!-- JavaScript -->
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let cartData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            checkAuthStatus();
            setupEventListeners();
        });

        /**
         * Load cart from API
         */
        async function loadCart() {
            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    cartData = await response.json();
                    displayCart(cartData.data);
                } else {
                    showError('Error loading cart');
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                showError('Error connecting to server');
            }
        }

        /**
         * Display cart items and summary
         */
        function displayCart(data) {
            const loadingState = document.getElementById('loadingState');
            const emptyCart = document.getElementById('emptyCart');
            const cartContent = document.getElementById('cartContent');

            loadingState.style.display = 'none';

            if (data.items.length === 0) {
                emptyCart.style.display = 'flex';
                cartContent.style.display = 'none';
                updateCartBadge(0);
            } else {
                emptyCart.style.display = 'none';
                cartContent.style.display = 'block';
                renderCartItems(data.items);
                renderSummary(data.summary);
                updateCartBadge(data.summary.total_items);
            }
        }

        /**
         * Render cart items
         */
        function renderCartItems(items) {
            const cartItemsContainer = document.getElementById('cartItems');
            cartItemsContainer.innerHTML = '';

            items.forEach(item => {
                const itemElement = createCartItemElement(item);
                cartItemsContainer.appendChild(itemElement);
            });
        }

        /**
         * Create cart item element
         */
        function createCartItemElement(item) {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.setAttribute('data-cart-id', item.cart_id);

            const discountPrice = item.discount_percentage > 0 
                ? item.price - (item.price * item.discount_percentage / 100)
                : item.price;

            div.innerHTML = `
                <div class="item-image">
                    <img src="${item.image_url}" alt="${item.product_name}" onerror="this.src='/img/default-product.png'">
                    ${item.discount_percentage > 0 ? `<span class="item-discount-badge">${item.discount_percentage}% OFF</span>` : ''}
                </div>
                <div class="item-details">
                    <h3 class="item-name">${item.product_name}</h3>
                    <p class="item-stock">
                        ${item.stock_quantity > 0 
                            ? `<span class="in-stock">In Stock (${item.stock_quantity} available)</span>`
                            : '<span class="out-of-stock">Out of Stock</span>'}
                    </p>
                    <div class="item-price">
                        ${item.discount_percentage > 0 
                            ? `<span class="price-original">$${item.price.toFixed(2)}</span>`
                            : ''}
                        <span class="price-current">$${discountPrice.toFixed(2)}</span>
                        <span class="price-per-unit">each</span>
                    </div>
                </div>
                <div class="item-quantity">
                    <label>Quantity:</label>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <input type="number" 
                               value="${item.quantity}" 
                               min="1" 
                               max="${item.stock_quantity}"
                               onchange="updateQuantity(${item.cart_id}, this.value)">
                        <button class="qty-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity + 1})" ${item.quantity >= item.stock_quantity ? 'disabled' : ''}>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="item-total">
                    <span class="total-label">Total:</span>
                    <span class="total-price">$${item.discounted_subtotal.toFixed(2)}</span>
                </div>
                <button class="item-remove" onclick="removeItem(${item.cart_id})" title="Remove item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;

            return div;
        }

        /**
         * Render order summary
         */
        function renderSummary(summary) {
            document.getElementById('summarySubtotal').textContent = `$${summary.subtotal.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `$${summary.total_amount.toFixed(2)}`;

            // Show/hide discount row
            const discountRow = document.getElementById('discountRow');
            if (summary.discount_amount > 0) {
                document.getElementById('summaryDiscount').textContent = `-$${summary.discount_amount.toFixed(2)}`;
                discountRow.style.display = 'flex';
            } else {
                discountRow.style.display = 'none';
            }
        }

        /**
         * Update cart item quantity
         */
        async function updateQuantity(cartId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            
            if (newQuantity < 1) return;

            try {
                const response = await fetch(`${API_BASE_URL}/cart/update/${cartId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ quantity: newQuantity })
                });

                if (response.ok) {
                    await loadCart(); // Reload cart
                } else {
                    const data = await response.json();
                    alert(data.message || 'Error updating quantity');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Error updating quantity');
            }
        }

        /**
         * Remove item from cart
         */
        async function removeItem(cartId) {
            if (!confirm('Remove this item from your cart?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/cart/remove/${cartId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadCart(); // Reload cart
                } else {
                    alert('Error removing item');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Error removing item');
            }
        }

        /**
         * Clear entire cart
         */
        async function clearCart() {
            if (!confirm('Are you sure you want to clear your entire cart?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/cart/clear`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadCart(); // Reload cart
                } else {
                    alert('Error clearing cart');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                alert('Error clearing cart');
            }
        }

        /**
         * Proceed to checkout
         */
        function proceedToCheckout() {
            // For now, redirect to contact page
            // In production, this would go to checkout flow
            if (confirm('Ready to complete your order? You will be redirected to contact us.')) {
                window.location.href = 'contact.html';
            }
        }

        /**
         * Check authentication status
         */
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    credentials: 'include'
                });

                const guestNotice = document.getElementById('guestNotice');
                
                if (response.ok) {
                    // User is logged in
                    guestNotice.style.display = 'none';
                } else {
                    // User is guest
                    guestNotice.style.display = 'block';
                }
            } catch (error) {
                console.log('Not logged in');
            }
        }

        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('checkoutBtn').addEventListener('click', proceedToCheckout);
        }

        /**
         * Update cart badge
         */
        function updateCartBadge(count) {
            const badge = document.getElementById('cartBadge');
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }

        /**
         * Show error message
         */
        function showError(message) {
            const loadingState = document.getElementById('loadingState');
            loadingState.innerHTML = `
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <p>${message}</p>
                <button onclick="location.reload()" class="retry-btn">Retry</button>
            `;
        }

        // Make functions available globally
        window.updateQuantity = updateQuantity;
        window.removeItem = removeItem;
    </script>

    <style>
        /* Cart Section */
        .cart-section {
            min-height: calc(100vh - 200px);
            padding: 40px 20px;
            background-color: #f5f5f5;
        }

        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .cart-title {
            color: #003366;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 100px 20px;
        }

        .loading-state svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Empty Cart */
        .empty-cart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            text-align: center;
        }

        .empty-cart h2 {
            color: #003366;
            font-size: 1.8em;
            margin: 20px 0 10px;
        }

        .empty-cart p {
            color: #666;
            margin-bottom: 30px;
        }

        .shop-now-btn {
            display: inline-block;
            background-color: #ff6600;
            color: white;
            padding: 15px 40px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .shop-now-btn:hover {
            background-color: #ff8533;
        }

        /* Cart Layout */
        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        /* Cart Items */
        .cart-items-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 120px 1fr 150px 120px 40px;
            gap: 20px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .cart-item:hover {
            border-color: #003366;
        }

        .item-image {
            position: relative;
        }

        .item-image img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }

        .item-discount-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #d32f2f;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 10px;
        }

        .item-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-name {
            color: #003366;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .item-stock {
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .in-stock {
            color: #4caf50;
            font-weight: 600;
        }

        .out-of-stock {
            color: #d32f2f;
            font-weight: 600;
        }

        .item-price {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .price-original {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
        }

        .price-current {
            color: #003366;
            font-size: 1.3em;
            font-weight: 700;
        }

        .price-per-unit {
            color: #666;
            font-size: 0.85em;
        }

        .item-quantity {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-quantity label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .qty-btn {
            width: 35px;
            height: 40px;
            border: none;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        .qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .quantity-controls input {
            width: 60px;
            text-align: center;
            border: none;
            font-size: 16px;
            font-weight: 600;
        }

        .item-total {
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: right;
        }

        .total-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .total-price {
            color: #003366;
            font-size: 1.3em;
            font-weight: 700;
        }

        .item-remove {
            background: none;
            border: none;
            color: #d32f2f;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .item-remove:hover {
            transform: scale(1.2);
        }

        /* Cart Actions */
        .cart-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .clear-cart-btn,
        .continue-shopping-btn {
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .clear-cart-btn {
            background-color: #f5f5f5;
            border: 2px solid #e0e0e0;
            color: #d32f2f;
            cursor: pointer;
        }

        .clear-cart-btn:hover {
            background-color: #ffebee;
            border-color: #d32f2f;
        }

        .continue-shopping-btn {
            background-color: #003366;
            color: white;
            border: none;
        }

        .continue-shopping-btn:hover {
            background-color: #004d99;
        }

        /* Cart Summary */
        .cart-summary-section {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .cart-summary {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .cart-summary h2 {
            color: #003366;
            font-size: 1.5em;
            margin-bottom: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        .discount-row .discount-amount {
            color: #4caf50;
            font-weight: 600;
        }

        .shipping-free {
            color: #4caf50;
            font-weight: 600;
        }

        .summary-divider {
            height: 2px;
            background-color: #f0f0f0;
            margin: 20px 0;
        }

        .total-row {
            font-size: 1.3em;
            font-weight: 700;
            color: #003366;
        }

        .total-amount {
            color: #ff6600;
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background-color 0.3s;
        }

        .checkout-btn:hover {
            background-color: #ff8533;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            color: #4caf50;
            font-size: 0.9em;
            font-weight: 600;
        }

        .guest-notice {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3e0;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9em;
        }

        .guest-notice a {
            color: #ff6600;
            font-weight: 600;
            text-decoration: none;
        }

        .guest-notice a:hover {
            text-decoration: underline;
        }

        .cart-btn-active {
            background-color: #ff8533;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .cart-layout {
                grid-template-columns: 1fr;
            }

            .cart-summary-section {
                position: static;
            }

            .cart-item {
                grid-template-columns: 100px 1fr;
                gap: 15px;
            }

            .item-quantity,
            .item-total {
                grid-column: 2;
            }

            .item-remove {
                grid-column: 2;
                justify-self: end;
            }
        }

        @media (max-width: 480px) {
            .cart-title {
                font-size: 1.8em;
            }

            .cart-item {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .item-quantity,
            .item-total,
            .item-remove {
                grid-column: 1;
            }

            .cart-actions {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</body>
</html>